<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Cambusa Scout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-toggle.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        #risultato, #listaSpesaContainer {
             background-color: #f0fdf4;
             border-left: 4px solid #22c55e;
             padding: 1.5rem;
        }
        select optgroup {
            font-weight: bold;
            color: #1f2937;
            background-color: #f9fafb;
        }
        .meal-slot { border-left: 3px solid #e5e7eb; }
        .meal-slot.merenda { border-left-color: #f59e0b; }
        
        /* Stili per il calendario */
        .day-cell {
            border: 1px solid #e5e7eb;
            height: 5rem;
            transition: all 0.2s ease;
        }
        .day-cell.clickable { cursor: pointer; }
        .day-cell.clickable:hover { background-color: #eff6ff; }
        .day-cell.selected { outline: 3px solid #3b82f6; outline-offset: -1px; background-color: #dbeafe; }
        .day-cell.disabled { background-color: #f3f4f6; color: #9ca3af; }
        .day-cell.complete { background-color: #dcfce7; color: #15803d; font-weight: bold; border-color: #86efac; }
        .day-cell.complete:hover { background-color: #bbf7d0; }
        .day-cell.selected.complete { background-color: #a7f3d0; outline-color: #16a34a; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen py-8">
    <div class="w-full max-w-7xl mx-auto p-4">
        
        <!-- Welcome Section -->
        <section id="welcomeSection" class="card text-center max-w-3xl mx-auto">
             <h1 class="text-4xl font-bold text-gray-800">Benvenuto nel Calcolatore Cambusa Scout!</h1>
             <p class="text-gray-600 mt-4 max-w-2xl mx-auto">
                Questo strumento ti aiuta a pianificare la cambusa per i tuoi campi estivi. Puoi fare un calcolo rapido per un singolo alimento, creare un menu giornaliero completo e generare automaticamente la lista della spesa.
             </p>
             <div class="mt-6 p-4 bg-amber-50 border-l-4 border-amber-400 text-amber-800 text-left rounded-r-lg">
                <div class="flex">
                    <div class="py-1"><i class="fas fa-exclamation-triangle mr-3 text-amber-500"></i></div>
                    <div>
                        <p class="font-bold">Attenzione</p>
                        <p class="text-sm">
                            Questo strumento è pensato per essere un aiuto e una guida generale. Le quantità calcolate sono delle stime basate su valori medi e non sostituiscono la valutazione di un cambusiere esperto. Usalo come un ottimo punto di partenza!
                        </p>
                    </div>
                </div>
            </div>
             <p class="text-gray-700 font-semibold mt-8 mb-4 text-xl">Per iniziare, scegli la tua branca:</p>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <button class="btn btn-primary text-2xl py-8" onclick="iniziaApplicazione('lupetto')">
                    <i class="fas fa-paw mr-4"></i> Lupetti / Coccinelle
                </button>
                <button class="btn btn-primary text-2xl py-8" onclick="iniziaApplicazione('reparto')">
                    <i class="fas fa-campground mr-4"></i> Esploratori / Guide
                </button>
             </div>
        </section>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <header class="text-center mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Calcolatore Cambusa Scout</h1>
                <p id="modalitaAttiva" class="text-gray-600 mt-2 text-xl font-semibold"></p>
            </header>

            <div class="flex justify-center flex-wrap gap-4 mb-6">
                <button id="btnModeMenu" class="btn btn-toggle" onclick="mostraSezione('menu')"><i class="fas fa-calendar-alt mr-2"></i> Il Tuo Menu</button>
                <button id="btnModeCalcolatore" class="btn btn-toggle btn-secondary" onclick="mostraSezione('calcolatore')"><i class="fas fa-calculator mr-2"></i> Calcolatore Veloce</button>
                <button id="btnModeFabbisogno" class="btn btn-toggle btn-secondary" onclick="mostraSezione('fabbisogno')"><i class="fas fa-book-open mr-2"></i> Fabbisogno Energetico</button>
            </div>

            <main id="calcolatoreSection" class="card hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Calcolatore Rapido per Singolo Alimento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div><label id="labelRagazziCalc" for="numRagazziCalc" class="block text-sm font-medium text-gray-700 mb-1">Numero Partecipanti</label><input type="number" id="numRagazziCalc" class="input-field" placeholder="Es. 20" min="0"></div>
                    <div><label for="numAdultiCalc" class="block text-sm font-medium text-gray-700 mb-1">Numero Adulti</label><input type="number" id="numAdultiCalc" class="input-field" placeholder="Es. 5" min="0"></div>
                    <div><label for="alimento" class="block text-sm font-medium text-gray-700 mb-1">Tipo di Alimento</label><select id="alimento" class="input-field"></select></div>
                    <div><label for="numPasti" class="block text-sm font-medium text-gray-700 mb-1">Numero di Pasti</label><input type="number" id="numPasti" class="input-field" placeholder="Es. 3" min="1"></div>
                </div>
                <button class="btn btn-primary w-full text-lg" onclick="calcolaQuantita()"><i class="fas fa-calculator mr-2"></i> Calcola Quantità</button>
                <div id="risultato" class="mt-8 p-6 rounded-lg hidden"></div>
                <div id="messaggioErrore" class="hidden mt-4 p-4 text-red-800 bg-red-100 border-l-4 border-red-500 rounded-lg"></div>
            </main>
            
            <section id="menuSection" class="card">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Crea il Tuo Menu e la Lista della Spesa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end bg-gray-50 p-4 rounded-lg mb-8">
                    <div><label id="labelRagazziMenu" for="menuNumRagazzi" class="block text-sm font-medium text-gray-700 mb-1">N. Partecipanti</label><input type="number" id="menuNumRagazzi" class="input-field" placeholder="0" min="0"></div>
                    <div><label for="menuNumAdulti" class="block text-sm font-medium text-gray-700 mb-1">N. Adulti</label><input type="number" id="menuNumAdulti" class="input-field" placeholder="0" min="0"></div>
                    <div><label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Data Inizio</label><input type="date" id="startDate" class="input-field"></div>
                    <div><label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Data Fine</label><input type="date" id="endDate" class="input-field"></div>
                    <div class="lg:col-span-4 flex justify-center items-end mt-4"><button class="btn btn-primary w-full sm:w-auto" onclick="generaCalendario()"><i class="fas fa-cogs mr-2"></i>Genera Calendario</button></div>
                </div>
                <div id="calendarioGridContainer" class="mb-8"></div>
                <div id="editorPastiContainer" class="hidden mt-8"></div>
                <div id="listaSpesaContainer" class="rounded-lg hidden"></div>
                <div id="menuMessaggioErrore" class="hidden mt-4 p-4 text-red-800 bg-red-100 border-l-4 border-red-500 rounded-lg"></div>
            </section>

            <section id="fabbisognoSection" class="card hidden"></section>
        </div>

    </div>

    <script>
        const porzioniCategorizzate = {
            "Carboidrati e Primi Piatti":{pane:{lupetto:60,reparto:90,adulto:110,unita:"g"},pasta:{lupetto:90,reparto:120,adulto:130,unita:"g"},patate:{lupetto:150,reparto:200,adulto:250,unita:"g"},riso:{lupetto:80,reparto:100,adulto:110,unita:"g"},polenta:{lupetto:60,reparto:80,adulto:100,unita:"g"},couscous:{lupetto:60,reparto:90,adulto:100,unita:"g"},crackers:{lupetto:25,reparto:35,adulto:40,unita:"g"}},
            "Carne, Pesce e Uova":{carne_rossa:{lupetto:100,reparto:150,adulto:180,unita:"g"},pesce:{lupetto:150,reparto:200,adulto:220,unita:"g"},pollo:{lupetto:120,reparto:180,adulto:200,unita:"g"},uova:{lupetto:1,reparto:2,adulto:2,unita:"pz"},wurstel:{lupetto:1,reparto:2,adulto:2,unita:"pz"},tonno:{lupetto:50,reparto:80,adulto:100,unita:"g"}},
            "Verdura e Legumi":{fagioli:{lupetto:50,reparto:70,adulto:80,unita:"g"},piselli:{lupetto:80,reparto:100,adulto:120,unita:"g"},pomodori:{lupetto:120,reparto:150,adulto:180,unita:"g"},insalata:{lupetto:70,reparto:90,adulto:100,unita:"g"},carote:{lupetto:100,reparto:130,adulto:150,unita:"g"},cipolle:{lupetto:30,reparto:40,adulto:50,unita:"g"},zucchine:{lupetto:120,reparto:160,adulto:180,unita:"g"},melanzane:{lupetto:120,reparto:160,adulto:180,unita:"g"},peperoni:{lupetto:100,reparto:140,adulto:160,unita:"g"},legumi_secchi:{lupetto:40,reparto:60,adulto:70,unita:"g"},passata_pomodoro:{lupetto:60,reparto:80,adulto:100,unita:"g"}},
            "Frutta":{mela:{lupetto:1,reparto:1,adulto:1,unita:"pz"},banana:{lupetto:1,reparto:1,adulto:1,unita:"pz"},pesca:{lupetto:1,reparto:1,adulto:1,unita:"pz"},anguria:{lupetto:300,reparto:400,adulto:500,unita:"g"},albicocca:{lupetto:2,reparto:3,adulto:3,unita:"pz"},pera:{lupetto:1,reparto:1,adulto:1,unita:"pz"},frutta_mista:{lupetto:150,reparto:200,adulto:250,unita:"g"}},
            "Latticini e Formaggi":{latte:{lupetto:250,reparto:300,adulto:300,unita:"ml"},yogurt:{lupetto:1,reparto:1,adulto:1,unita:"pz"},formaggio_fresco:{lupetto:70,reparto:100,adulto:120,unita:"g"},formaggio_stagionato:{lupetto:40,reparto:50,adulto:60,unita:"g"},mozzarella:{lupetto:80,reparto:100,adulto:120,unita:"g"}},
            "Dolci e Extra":{biscotti:{lupetto:40,reparto:60,adulto:50,unita:"g"},cereali_colazione:{lupetto:30,reparto:50,adulto:50,unita:"g"},fette_biscottate:{lupetto:3,reparto:4,adulto:4,unita:"pz"},marmellata:{lupetto:20,reparto:30,adulto:30,unita:"g"},miele:{lupetto:15,reparto:20,adulto:20,unita:"g"},cioccolato:{lupetto:20,reparto:30,adulto:30,unita:"g"},cacao:{lupetto:5,reparto:7,adulto:10,unita:"g"}},
            "Condimenti":{olio:{lupetto:10,reparto:15,adulto:20,unita:"ml"},sale:{lupetto:3,reparto:5,adulto:5,unita:"g"},burro:{lupetto:10,reparto:15,adulto:20,unita:"g"}}
        };
        const porzioni = {};
        for (const cat in porzioniCategorizzate) Object.assign(porzioni, porzioniCategorizzate[cat]);
        
        // --- STATO GLOBALE ---
        let brancaSelezionata = null;
        let menuData = {};
        let giornoSelezionato = null;
        const CONDIMENT_MULTIPLIER = 0.35; // Moltiplicatore per porzioni da condimento

        // --- FUNZIONI DI UTILITY E INIZIALIZZAZIONE ---
        function popolaSelectAlimenti(selectElement) {
            if (!selectElement) return;
            selectElement.innerHTML = '';
            for (const categoria in porzioniCategorizzate) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = categoria;
                const chiaviOrdinate = Object.keys(porzioniCategorizzate[categoria]).sort();
                chiaviOrdinate.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    optgroup.appendChild(option);
                });
                selectElement.appendChild(optgroup);
            }
        }

        function mostraErrore(messaggio, contesto = 'calcolatore') {
            const errorDiv = document.getElementById(contesto === 'menu' ? 'menuMessaggioErrore' : 'messaggioErrore');
            errorDiv.textContent = messaggio;
            errorDiv.classList.toggle('hidden', !messaggio);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('calendarioGridContainer').addEventListener('click', gestisciClickGiorno);
            document.getElementById('editorPastiContainer').addEventListener('click', gestisciClickEditor);
        });

        function iniziaApplicazione(branca) {
            brancaSelezionata = branca;
            document.getElementById('welcomeSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            const nomeBranca = branca === 'lupetto' ? 'Lupetti / Coccinelle' : 'Esploratori / Guide';
            document.getElementById('modalitaAttiva').innerHTML = `Modalità Attiva: <span class="text-green-700">${nomeBranca}</span>`;
            
            const nomePartecipanti = branca === 'lupetto' ? 'N. Lupetti/e' : 'N. Esplo/Guide';
            document.getElementById('labelRagazziCalc').textContent = nomePartecipanti;
            document.getElementById('labelRagazziMenu').textContent = nomePartecipanti;

            popolaSelectAlimenti(document.getElementById('alimento'));
            popolaSezioneFabbisogno();
            mostraSezione('menu');
        }

        function mostraSezione(sezione) {
            ['calcolatoreSection', 'fabbisognoSection', 'menuSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
            ['btnModeCalcolatore', 'btnModeFabbisogno', 'btnModeMenu'].forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('active', 'btn-secondary');
                btn.classList.add(id.toLowerCase().includes(sezione) ? 'active' : 'btn-secondary');
            });
            document.getElementById(sezione + 'Section').classList.remove('hidden');
        }

        function popolaSezioneFabbisogno() {
            const container = document.getElementById('fabbisognoSection');
            const datiFabbisogno = brancaSelezionata === 'lupetto' 
                ? { kcal: '~ 2100 Kcal', proteine: '~ 70 g', grassi: '~ 65 g', carboidrati: '~ 275 g' }
                : { kcal: '~ 2500 Kcal', proteine: '~ 85 g', grassi: '~ 75 g', carboidrati: '~ 330 g' };
            container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Fabbisogno Energetico di Riferimento</h2><p class="text-gray-600 mb-6 text-center">Valori medi giornalieri per la branca <strong>${brancaSelezionata === 'lupetto' ? 'Lupetti/Coccinelle' : 'Esploratori/Guide'}</strong>.</p><div class="overflow-x-auto"><table class="w-full text-left table-auto"><thead class="bg-gray-100"><tr><th class="text-base font-semibold text-gray-700">Nutriente</th><th class="text-base font-semibold text-gray-700 text-center">Quantità Giornaliera</th></tr></thead><tbody><tr><td class="font-medium text-gray-800">Fabbisogno Calorico</td><td class="text-center font-semibold text-lg text-blue-600">${datiFabbisogno.kcal}</td></tr><tr class="bg-gray-50"><td class="font-medium text-gray-800">Proteine</td><td class="text-center"><div class="text-lg font-semibold text-gray-800">${datiFabbisogno.proteine}</div></td></tr><tr><td class="font-medium text-gray-800">Grassi</td><td class="text-center"><div class="text-lg font-semibold text-gray-800">${datiFabbisogno.grassi}</div></td></tr><tr class="bg-gray-50"><td class="font-medium text-gray-800">Carboidrati</td><td class="text-center"><div class="text-lg font-semibold text-gray-800">${datiFabbisogno.carboidrati}</div></td></tr></tbody></table></div><footer class="text-center mt-6"><p class="text-xs text-gray-500">Fonte: Elaborazione su dati LARN (SINU, 2014).</p></footer>`;
        }

        function calcolaQuantita() {
            const risultatoDiv = document.getElementById('risultato');
            risultatoDiv.innerHTML = '';
            risultatoDiv.classList.add('hidden');
            
            const numRagazzi = parseInt(document.getElementById('numRagazziCalc').value) || 0;
            const numAdulti = parseInt(document.getElementById('numAdultiCalc').value) || 0;
            const alimentoScelto = document.getElementById('alimento').value;
            const numPasti = parseInt(document.getElementById('numPasti').value) || 0;
            
            if ((numRagazzi <= 0 && numAdulti <= 0) || numPasti <= 0) {
                 mostraErrore("Compila tutti i campi numerici con valori maggiori di zero.", 'calcolatore');
                 return;
            }
            mostraErrore("", 'calcolatore');

            const porzioneRagazzo = porzioni[alimentoScelto][brancaSelezionata];
            const porzioneAdulto = porzioni[alimentoScelto]['adulto'];
            const tipoUnita = porzioni[alimentoScelto]['unita'];
            const totaleComplessivo = (numRagazzi * porzioneRagazzo * numPasti) + (numAdulti * porzioneAdulto * numPasti);
            const nomeBranca = brancaSelezionata === 'lupetto' ? 'Lupetti/e' : 'Esplo/Guide';
            
            let outputPrincipale = '';
            if (tipoUnita === 'g' || tipoUnita === 'ml') {
                outputPrincipale = totaleComplessivo >= 1000 
                    ? `${(totaleComplessivo / 1000).toFixed(2)} ${tipoUnita === 'g' ? 'kg' : 'L'}`
                    : `${Math.round(totaleComplessivo)} ${tipoUnita === 'g' ? 'grammi' : 'millilitri'}`;
            } else if (tipoUnita === 'pz') {
                 outputPrincipale = `${Math.ceil(totaleComplessivo)} pezzi`;
            }

            const dettaglioPorzioni = `(${porzioneRagazzo}${tipoUnita} a testa per ${nomeBranca} e ${porzioneAdulto}${tipoUnita} a testa per Adulti)`;
            
            risultatoDiv.innerHTML = `<h3 class="text-2xl font-bold text-gray-800 mb-4">Quantità Totale Necessaria</h3><div class="text-sm text-gray-600 mb-4">Calcolo basato su <strong>${numRagazzi} ${nomeBranca}</strong>, <strong>${numAdulti} Adulti</strong> per <strong>${numPasti} pasti</strong>.</div><div class="text-3xl font-bold text-green-700">${outputPrincipale}</div><div class="text-base font-semibold text-green-600 mt-1">${dettaglioPorzioni}</div>`;
            risultatoDiv.classList.remove('hidden');
        }
        
        function generaCalendario() {
            const container = document.getElementById('calendarioGridContainer');
            const editorContainer = document.getElementById('editorPastiContainer');
            const listaSpesaCont = document.getElementById('listaSpesaContainer');
            container.innerHTML = '';
            editorContainer.innerHTML = '';
            editorContainer.classList.add('hidden');
            listaSpesaCont.classList.add('hidden');
            giornoSelezionato = null;

            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const numRagazzi = parseInt(document.getElementById('menuNumRagazzi').value) || 0;
            const numAdulti = parseInt(document.getElementById('menuNumAdulti').value) || 0;
            
            mostraErrore('', 'menu');
            if (isNaN(startDate) || isNaN(endDate) || (numRagazzi <= 0 && numAdulti <= 0)) {
                mostraErrore("Compila tutti i campi: date e numero partecipanti.", "menu"); return;
            }
            if (startDate > endDate) { mostraErrore("La data di inizio non può essere successiva alla data di fine.", "menu"); return; }

            menuData = {};
            let currentDate = new Date(startDate);
            while(currentDate <= endDate) {
                const dateString = currentDate.toISOString().split('T')[0];
                menuData[dateString] = { colazione: [], pranzo: [], merenda: [], cena: [] };
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const monthName = startDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            container.innerHTML = `<h3 class="text-xl font-bold text-center mb-2 capitalize">${monthName}</h3>`;

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-7 text-center';
            
            ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'].forEach(day => grid.innerHTML += `<div class="font-bold p-2">${day}</div>`);
            
            let firstDay = startDate.getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1;

            for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';

            Object.keys(menuData).forEach(dateString => {
                const date = new Date(dateString + 'T12:00:00');
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell clickable flex items-center justify-center';
                dayCell.dataset.date = dateString;
                dayCell.textContent = date.getDate();
                grid.appendChild(dayCell);
            });
            container.appendChild(grid);
        }

        function gestisciClickGiorno(event) {
            const target = event.target.closest('.clickable');
            if (!target) return;
            if (giornoSelezionato) giornoSelezionato.classList.remove('selected');
            giornoSelezionato = target;
            giornoSelezionato.classList.add('selected');
            mostraEditorPasti(target.dataset.date);
        }
        
        function mostraEditorPasti(dateString) {
            const editorContainer = document.getElementById('editorPastiContainer');
            const date = new Date(dateString + 'T12:00:00');
            editorContainer.classList.remove('hidden');
            editorContainer.innerHTML = `<div class="card bg-blue-50"><h3 class="text-xl font-bold text-center mb-4">Modifica Menu per: <span class="text-blue-700">${date.toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long'})}</span></h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${['colazione','pranzo','merenda','cena'].map(p => creaSlotPastoEditor(dateString, p)).join('')}</div></div>`;
            renderPasti(dateString);
        }

        function creaSlotPastoEditor(dateString, tipoPasto) {
            const nomiPasti = { colazione: 'Colazione', pranzo: 'Pranzo', merenda: 'Merenda', cena: 'Cena' };
            const isMerenda = tipoPasto === 'merenda';
            const showCondimentCheckbox = (tipoPasto === 'pranzo' || tipoPasto === 'cena');

            return `<div class="meal-slot ${isMerenda ? 'merenda p-2' : 'p-4'} rounded-lg space-y-2 bg-white shadow-sm"><h4 class="font-semibold ${isMerenda ? 'text-sm' : 'text-md'} text-gray-700">${nomiPasti[tipoPasto]}</h4><ul id="lista-${tipoPasto}-${dateString}" class="text-sm space-y-1 min-h-[2rem]"></ul><div class="flex gap-2 pt-2 items-center flex-wrap"><select class="input-field text-sm flex-grow" id="select-${tipoPasto}-${dateString}"></select>${showCondimentCheckbox ? `<div class="flex items-center gap-1"><input type="checkbox" id="condiment-${tipoPasto}-${dateString}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="condiment-${tipoPasto}-${dateString}" class="text-xs text-gray-600">Come condimento</label></div>` : ''}<button class="btn btn-primary btn-sm p-2 ml-auto" data-action="add" data-date="${dateString}" data-meal="${tipoPasto}"><i class="fas fa-plus"></i></button></div></div>`;
        }

        function gestisciClickEditor(event) {
            const target = event.target.closest('button');
            if (!target) return;
            const { action, date, meal, index } = target.dataset;
            let menuCambiato = false;
            if (action === 'add') {
                const select = document.getElementById(`select-${meal}-${date}`);
                const condimentCheckbox = document.getElementById(`condiment-${meal}-${date}`);
                const isCondiment = condimentCheckbox ? condimentCheckbox.checked : false;
                if (select.value) { 
                    menuData[date][meal].push({alimento: select.value, isCondiment: isCondiment}); 
                    menuCambiato = true; 
                }
            } else if (action === 'remove') {
                menuData[date][meal].splice(index, 1);
                menuCambiato = true;
            }
            if(menuCambiato) {
                renderPasti(date);
                aggiornaListaSpesa();
                aggiornaStatoGiorno(date);
            }
        }

        function renderPasti(dateString) {
            Object.keys(menuData[dateString]).forEach(pasto => {
                const ul = document.getElementById(`lista-${pasto}-${dateString}`);
                if (!ul) return;
                ul.innerHTML = '';
                menuData[dateString][pasto].forEach((item, index) => {
                    const condimentTag = item.isCondiment ? '<span class="text-xs text-gray-500 ml-1">(cond.)</span>' : '';
                    ul.innerHTML += `<li class="flex justify-between items-center bg-gray-100 p-1 rounded"><span>${item.alimento.replace(/_/g, ' ')} ${condimentTag}</span><button class="text-red-500 hover:text-red-700" data-action="remove" data-date="${dateString}" data-meal="${pasto}" data-index="${index}"><i class="fas fa-times-circle"></i></button></li>`;
                });
                const select = document.getElementById(`select-${pasto}-${dateString}`);
                if (select && !select.childElementCount) popolaSelectAlimenti(select);
            });
        }
        
        function aggiornaStatoGiorno(dateString) {
            if (!menuData[dateString]) return;
            const dayData = menuData[dateString];
            const isComplete = dayData.colazione.length > 0 && dayData.pranzo.length > 0 && dayData.cena.length > 0;
            const dayCell = document.querySelector(`.day-cell[data-date="${dateString}"]`);
            if (dayCell) dayCell.classList.toggle('complete', isComplete);
        }
        
        function aggiornaListaSpesa() {
            const listaContainer = document.getElementById('listaSpesaContainer');
            const numRagazzi = parseInt(document.getElementById('menuNumRagazzi').value) || 0;
            const numAdulti = parseInt(document.getElementById('menuNumAdulti').value) || 0;

            if (numRagazzi <= 0 && numAdulti <= 0) { listaContainer.classList.add('hidden'); return; }

            const spesaTotale = {};
            for (const date in menuData) {
                for (const pasto in menuData[date]) {
                    menuData[date][pasto].forEach(item => {
                        const alimento = item.alimento;
                        if (!spesaTotale[alimento]) spesaTotale[alimento] = 0;
                        
                        const multiplier = item.isCondiment ? CONDIMENT_MULTIPLIER : 1;
                        const porzioneRagazzo = porzioni[alimento][brancaSelezionata] * multiplier;
                        const porzioneAdulto = porzioni[alimento].adulto * multiplier;
                        
                        spesaTotale[alimento] += (numRagazzi * porzioneRagazzo) + (numAdulti * porzioneAdulto);
                    });
                }
            }
            
            if (Object.keys(spesaTotale).length === 0) {
                 listaContainer.innerHTML = '<p class="text-center text-gray-500">La tua lista della spesa è vuota. Aggiungi alimenti al menu.</p>';
                 listaContainer.classList.remove('hidden');
                 return;
            }
            listaContainer.classList.remove('hidden');
            let html = '<h3 class="text-2xl font-bold text-gray-800 mb-4">Lista della Spesa Totale</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-2">';
            const chiaviOrdinate = Object.keys(spesaTotale).sort();
            chiaviOrdinate.forEach(alimento => {
                const totale = spesaTotale[alimento];
                const unita = porzioni[alimento].unita;
                let displayValue = '';
                if (unita === 'g' || unita === 'ml') {
                    displayValue = totale >= 1000 ? `<strong>${(totale / 1000).toFixed(2)}</strong> ${unita === 'g' ? 'kg' : 'L'}` : `<strong>${Math.ceil(totale)}</strong> ${unita}`;
                } else {
                    displayValue = `<strong>${Math.ceil(totale)}</strong> ${unita}`;
                }
                html += `<div class="text-gray-700 flex justify-between border-b border-dashed"><span>${alimento.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span><span class="font-semibold text-green-800 text-right">${displayValue}</span></div>`;
            });
            html += '</div>';
            listaContainer.innerHTML = html;
        }
    </script>
</body>
</html>
